    1: """CLI entry point for executing Village of Words experiments."""
    1: from __future__ import annotations
       
    1: import argparse
    1: import asyncio
    1: import json
    1: from pathlib import Path
    1: from typing import Any, Dict, List
       
    1: from src.agents.agent_manager import AgentConfig, AgentManager
    1: from src.agents.llm_wrapper import AgentTurn, LLMWrapper, PromptPayload
    1: from src.simulator.turn_manager import PhaseConfig, TurnConfig, TurnManager
    1: from src.utils.config import get_section, load_config, resolve_path
       
       
    1: def build_agent_configs(config: Dict[str, Any]) -> List[AgentConfig]:
    1:     agents_config: List[AgentConfig] = []
    2:     for agent in config.get("agents", []):
    2:         agents_config.append(
    2:             AgentConfig(
    1:                 agent_id=str(agent["agent_id"]),
    1:                 name=str(agent.get("name", agent["agent_id"])),
    1:                 role=str(agent.get("role", "")),
    1:                 port=int(agent.get("port", 0)),
    1:                 traits={k: str(v) for k, v in agent.get("traits", {}).items()},
    2:                 resources={k: float(v) for k, v in agent.get("resources", {}).items()},
                   )
               )
    1:     return agents_config
       
       
    1: def build_turn_config(raw: Dict[str, Any], override_max_turns: int | None = None) -> TurnConfig:
    1:     experiment = get_section(raw, "experiment")
    1:     scenario = get_section(raw, "scenario")
       
    1:     base_dir = Path(raw.get("base_dir", "."))
    1:     log_path = resolve_path(base_dir, experiment.get("log_path", "results/events.jsonl"))
       
    1:     seed = int(experiment.get("seed", 42))
    1:     max_turns = int(override_max_turns or experiment.get("max_turns", 10))
       
    1:     phases: List[PhaseConfig] = []
    2:     for phase in scenario.get("phases", []):
    1:         turns = phase.get("turns", [1, max_turns])
    2:         phases.append(
    2:             PhaseConfig(
    1:                 name=str(phase.get("name", "phase")),
    1:                 start=int(turns[0]),
    1:                 end=int(turns[1]),
    1:                 event=phase.get("event"),
    1:                 parameters=phase.get("parameters", {}),
    1:                 constraints=phase.get("constraints", {}),
                   )
               )
       
    2:     return TurnConfig(
    1:         seed=seed,
    1:         max_turns=max_turns,
    1:         log_path=log_path,
    1:         phases=phases,
           )
       
       
    2: class DryRunWrapper(LLMWrapper):
    1:     """Simple deterministic wrapper for --dry-run executions."""
       
    1:     RESPONSES = (
               ("Assessing the plan", "Join", "I'll contribute resources."),
               ("Unsure about current plan", "Observe", "I'll wait this turn."),
               ("Gathering feedback", "Cooperate", "Let's coordinate efforts."),
           )
       
    1:     def __init__(self, agent_id: str):
    1:         super().__init__(base_url="dry-run")
    1:         self.agent_id = agent_id
    1:         self._cursor = 0
       
    1:     async def chat(self, agent_id: str, payload: PromptPayload) -> AgentTurn:  # type: ignore[override]
    1:         thought, decision, message = self.RESPONSES[self._cursor % len(self.RESPONSES)]
    1:         self._cursor += 1
    2:         return AgentTurn(
    1:             agent_id=agent_id,
    1:             thought=thought,
    1:             decision=decision,
    1:             message=message,
    1:             raw_response={"dry_run": True, "history_length": len(payload.history)},
               )
       
       
    1: async def run_experiment(args: argparse.Namespace) -> None:
    1:     config_path = Path(args.config)
    1:     raw_config = load_config(config_path)
       
    1:     agent_configs = build_agent_configs(raw_config)
    1:     agent_manager = AgentManager(agent_configs)
       
    1:     experiment_section = get_section(raw_config, "experiment")
    1:     seed = args.seed if args.seed is not None else experiment_section.get("seed", 42)
    1:     turn_config = build_turn_config(raw_config, override_max_turns=args.max_turns)
    1:     turn_config.seed = int(seed)
       
    1:     if args.dry_run:
    2:         wrappers = {
    2:             cfg.agent_id: DryRunWrapper(cfg.agent_id) for cfg in agent_configs
               }
           else:
>>>>>>         wrappers = {
>>>>>>             cfg.agent_id: LLMWrapper(base_url=f"http://localhost:{cfg.port}")
>>>>>>             for cfg in agent_configs
               }
       
    1:     manager = TurnManager(agent_manager, wrappers, turn_config)
    1:     results = await manager.run()
       
    1:     metrics_path = experiment_section.get("metrics_path")
    1:     if metrics_path:
    1:         metrics_path = resolve_path(Path(raw_config["base_dir"]), metrics_path)
    1:         metrics_path.parent.mkdir(parents=True, exist_ok=True)
    2:         metrics_path.write_text(
    2:             json.dumps(
    1:                 {
    1:                     "turns": len(results),
    1:                     "log_path": str(turn_config.log_path),
    1:                     "dry_run": bool(args.dry_run),
                       },
    1:                 indent=2,
    1:                 ensure_ascii=True,
                   ),
    1:             encoding="utf-8",
               )
       
    2:     print(  # noqa: T201 - CLI status output
    1:         "Run completed.",
    2:         json.dumps(
    1:             {
    1:                 "turns": len(results),
    1:                 "log": str(turn_config.log_path),
    1:                 "dry_run": bool(args.dry_run),
                   }
               ),
           )
       
       
    1: def build_parser() -> argparse.ArgumentParser:
    1:     parser = argparse.ArgumentParser(description="Run Village of Words experiments")
    1:     parser.add_argument("--config", required=True, help="Path to experiment config (YAML or JSON)")
    1:     parser.add_argument("--seed", type=int, help="Override RNG seed")
    1:     parser.add_argument("--max-turns", type=int, help="Override maximum turns")
    1:     parser.add_argument("--dry-run", action="store_true", help="Use deterministic local responses")
    1:     return parser
       
       
    1: def main(argv: List[str] | None = None) -> None:
    1:     parser = build_parser()
    1:     args = parser.parse_args(argv)
    1:     asyncio.run(run_experiment(args))
       
       
    1: if __name__ == "__main__":
>>>>>>     main()
